<div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
  <div>
    <p class="text-uppercase text-muted small mb-1">Season <%= @season.year %></p>
    <h1 class="mb-1">Episode <%= @episode.number %></h1>
    <p class="text-muted mb-2">Air Date: <strong><%= @episode.air_date ? l(@episode.air_date, format: :long) : "TBD" %></strong></p>
    <div class="btn-group" role="group">
      <%= link_to "Back to Season", season_path(@season), class: "btn btn-outline-secondary" %>
      <% if admin? %>
        <%= link_to "Edit Episode", edit_season_episode_path(@season, @episode), class: "btn btn-outline-primary" %>
        <%= link_to "Delete Episode", season_episode_path(@season, @episode), class: "btn btn-outline-danger", data: { turbo_method: :delete, turbo_confirm: "Delete this episode?" } %>
      <% end %>
    </div>
  </div>
  <div class="text-end">
    <% if admin? %>
      <% if @result.present? %>
        <%= link_to "Update Result", edit_season_episode_result_path(@season, @episode), class: "btn btn-primary" %>
      <% else %>
        <%= link_to "Record Result", new_season_episode_result_path(@season, @episode), class: "btn btn-primary" %>
      <% end %>
    <% end %>
  </div>
</div>

<div class="row g-4">
  <div class="col-xl-5">
    <div class="d-flex flex-column gap-3">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Episode Result</h2>
          <% if @result.present? %>
            <span class="badge bg-success">Finalized</span>
          <% else %>
            <span class="badge bg-warning text-dark">Pending</span>
          <% end %>
        </div>
        <div class="card-body">
          <% if @result.present? %>
            <dl class="row mb-0">
              <dt class="col-6 text-muted">Star Baker</dt>
              <dd class="col-6 fw-semibold"><%= @result.star_baker&.name || "TBD" %></dd>
              <dt class="col-6 text-muted">Technical Winner</dt>
              <dd class="col-6 fw-semibold"><%= @result.technical_winner&.name || "TBD" %></dd>
              <dt class="col-6 text-muted">Handshake</dt>
              <dd class="col-6 fw-semibold"><%= @result.handshake&.name || "None" %></dd>
              <dt class="col-6 text-muted">Eliminated</dt>
              <dd class="col-6 fw-semibold"><%= @result.eliminated&.name || "TBD" %></dd>
            </dl>
          <% else %>
            <p class="text-muted mb-0">No official result yet.</p>
          <% end %>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">Your Weekly Pick</h2>
        </div>
        <div class="card-body">
          <% pick = @user_pick || @episode.picks.build(user: current_user) %>
          <% if pick.persisted? %>
            <p class="text-muted">You can update your pick up until the episode airs.</p>
          <% else %>
            <p class="text-muted">Make your selections before the episode airs.</p>
          <% end %>
          <%= render "picks/form", pick: pick %>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-7">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">All Picks</h2>
        <span class="badge bg-secondary"><%= pluralize(@picks.count, "entry") %></span>
      </div>
      <div class="card-body">
        <% if @picks.any? %>
          <div class="list-group list-group-flush">
            <% @picks.each do |pick| %>
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h3 class="h6 mb-1"><%= pick.user&.name || "Unknown" %></h3>
                    <p class="mb-0 small text-muted">
                      Star Baker: <strong><%= pick.star_baker&.name || "TBD" %></strong><br>
                      Technical Winner: <strong><%= pick.technical_winner&.name || "TBD" %></strong><br>
                      Handshake: <strong><%= pick.handshake&.name || "TBD" %></strong>
                    </p>
                  </div>
                  <% if admin? || pick.user == current_user %>
                    <div class="btn-group btn-group-sm" role="group">
                      <%= link_to "Edit", edit_season_episode_pick_path(@season, @episode, pick), class: "btn btn-outline-primary" %>
                      <%= link_to "Delete", season_episode_pick_path(@season, @episode, pick), class: "btn btn-outline-danger", data: { turbo_method: :delete, turbo_confirm: "Remove this pick?" } %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted mb-0">No picks submitted yet.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
